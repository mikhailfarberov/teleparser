# Краткое ТЗ для Телепарсера

v2.4-20200303

## Источники

Необходимо парсить данные из следующих источников:

- Телеграм (по id канала): пост и приложенные медиа-файлы (в т.ч. галлерея)
- Инстаграм (профиль пользователя): медиа-файлы (в т.ч. галлерея) и описание от автора (визуально в веб версии это как первый коммент показывается)
- vk (стена сообщества, стена пользователя): пост и приложенные медиа-файлы (картинки, видео, аудио)

## Фильтрация контента

Имеется два уровня фильтрации.

- Глобальный, применяется ко всем сообщениям, попадаемым в систему (типа "блокируем все посты со словом `распродажа`")
- Локальный, применяемый к сообщениям из конкретного источника (типа "на канале `всё для себя` блокируем все посты со словами `распродажа`")

Каждый фильтр блокирует сообщения:

- содержащие ссылки, кроме списка разрешённых ссылок (мы имеем белый список ссылок, которые можно пропускать)
- содержащие стоп-слова (мы имеем чёрный список слов, появление которых блокирует пост)

Стоп слова могут быть заданы в формате маски, чтоб не возиться с падежами и склонениями, т.е. может быть формат `распродаж*`

Правила фильтрации настраиваются через веб-интерфейс.
Можно задать правила, просмотреть отфильтрованные посты, опубликовать отфильтрованные посты.

## Замена

По аналогии с фильтрацией, есть правила замены, задаваемые в виде пары ["старое значение", "новое значение"].
Для замены используется только строгое совпадение (никаких масок).
Правила могут применяться глобально (для всех постов) и локально (для постов из источника).

Правила замены задаются через веб-интерфейс.
Их можно отредактировать, увидеть историю замен.

## Публикация контента

После фильтрации и замен, посты попадают в локальную зазу данных.

Контент может публиковаться по следующим сценариям:

- синхронно, по мере появления в локальной БД (в конфиге флаг "posting: Immediately")
- вручную (в конфиге флаг "posting: Manually")
- по расписанию с элементами рандома (в конфиге флаг "posting: Timetable")

Кроме того, при публикации по расписанию возможна преподерация контента:

- Если на источнике стоит метка "requireReview: False", то сообщения заносятся в БД доступные для публикации.
- Если на источнике стоит метка "requireReview: True", то сообщения заносятся в базу, и оператор должен разрешить каждый пост к публикации.

Таким образом, для публикации по расписанию необходимо выкачать контент на сколько получится, а потом рандомно выбирать записи из тех, которые ранее не публиковались, и которые разрешены для публикации. Публикуются записи в заданное время с заданным интервалом (отмечая опубликованные посты).

Пример:

```
requireReview: False
postingTime: 09,18
postingInterval: 3,5
```

Означает, что все посты источника парсятся сразу доступными для публикации и публикуются с 9 утра до 6 вечера с интервалом от 3 до 5 часов (т.е. после каждого поста запускается счётчик на рандомное количество минут от 3 до 5 часов, если наступает 18 часов, то счётчик ставится на паузу до 9 утра).

В базе данных отмечать публикацию контента таймстемпом этой публикации и два раза одну записть не публиковать.

## Особый случай

1. Телеграм может прислать 5-ть картинок 5-ю разными сообщениями. Необходимо постить это в Sendy одним постом, т.е. надо посмотреть какой признак передаётся в Telegram, чтоб клиент понимал что это одно сообщения.

2. Если запись была отредактирована в источнике и не была ещё опубликована в Sendy, то обновлять её в локальной БД.

3. Мы активно используем telepost для вставки изображений. Он не аттачит картинку к посту, он загружает картинку на свой сервер, а в пост вставляет ссылку. Такие кейсы нужно тоже обрабатывать и аттачить картнку к посту Sendy обычным образом.

Проблема выглядит обычно так:

`'[\u200b\u200b](https://tgraph.io/file/f0004153f30df3cc1e5bb.jpg)У большинства людей левая сторона лица считается более привлекательной, чем правая'`

## Веб-интерфейс

Интерфейс помогает оператору использовать парсер. Доступны следующие возможности:

- редактирование конфиг-файлов (в т.ч. указание новых источников, определение режима постинга, управление глобальным списком стоп-слов и разрешённых УРЛов, указание замен)
- возможность добавлять комментарий с источнику (это не влияет на логику, это нужно только для оператора)
- просматривать скачанные посты (в т.ч. видеть время их публикации в Sendy)
- публикация поста по клику из веб-интерфейса в Sendy, либо снимать посты с печати
- просмотр постов, которые не прошли проверку по фильтрам

## Ватермарки

[фича требует дополнительного изучения]

Некоторые изображения содержат вотермарки.
Нужно ставить свои вотермарки поверх исходных,чтобы сделать исходные нечитаемыми.
Для каждого источника будет задаваться куда и какую ватермарку лепить.

## Имплементация

Желательно всё сделать на Python и внутри Docker-контейнера.

В качестве БД лучше использовать sqlite примантированный снаружи, так проще рестартовать контейнер не беспокоясь о Редисе.